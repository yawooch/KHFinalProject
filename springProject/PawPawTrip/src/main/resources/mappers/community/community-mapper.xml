<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper 
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
	
<mapper namespace="com.kr.pawpawtrip.community.model.mapper.CommunityMapper">
	<sql id="communityListSql">
		SELECT COMMUNITY_NO,
			   COMMUNITY_CATEGORY,
			   COMMUNITY_TITLE,
			   COMMUNITY_CONTENT,
			   COMMUNITY_ED,
			   COMMUNITY_STATUS,
			   COMMUNITY_COUNT,
			   COMMUNITY_O_FILENAME,
			   COMMUNITY_R_FILENAME,
			   NOTICE_IMPORTANT_YN,
			   COMMUNITY_WRITER_NO
		FROM COMMUNITY
	</sql>
	
	<resultMap id="communityListResultMap" type="Community">
		<id property="communityNo" column="COMMUNITY_NO" />
		<result property="communityRNUM" column="RNUM" />
		<result property="communityCategory" column="COMMUNITY_CATEGORY" />
		<result property="communityTitle" column="COMMUNITY_TITLE" />
		<result property="communityContent" column="COMMUNITY_CONTENT" />
		<result property="communityEd" column="COMMUNITY_ED" />
		<result property="communityStatus" column="COMMUNITY_STATUS" />
		<result property="communityCount" column="COMMUNITY_COUNT" />
		<result property="communityOfileName" column="COMMUNITY_O_FILENAME" />
		<result property="communityRfileName" column="COMMUNITY_R_FILENAME" />
		<result property="noticeImportantYN" column="NOTICE_IMPORTANT_YN" />
		<result property="communityWriterNo" column="COMMUNITY_WRITER_NO" />
		<result property="communityWriterId" column="MEMBER_ID" />
	</resultMap>	

	<!-- 조회 -->
	<select id="selectBoardCount">
		SELECT COUNT(*) FROM COMMUNITY
		WHERE COMMUNITY_CATEGORY IN ('[수다]', '[마이펫 자랑]')
	</select>
	
	<select id="selectNoticeList" resultMap="communityListResultMap">
		<include refid="communityListSql" />
		WHERE COMMUNITY_STATUS = 'Y'
		AND COMMUNITY_CATEGORY = '[공지사항]'
		ORDER BY COMMUNITY_ED DESC
	</select>
	
	<select id="selectBoardList" resultMap="communityListResultMap">
		SELECT RNUM, COMMUNITY_NO, COMMUNITY_CATEGORY, COMMUNITY_TITLE, MEMBER_ID, COMMUNITY_COUNT, COMMUNITY_ED
		FROM (
		    SELECT ROWNUM AS RNUM, COMMUNITY_NO, COMMUNITY_CATEGORY, COMMUNITY_TITLE, MEMBER_ID, COMMUNITY_COUNT, COMMUNITY_ED
		    FROM(
		        SELECT C.COMMUNITY_NO,
		               C.COMMUNITY_CATEGORY,
		               C.COMMUNITY_TITLE,
		               M.MEMBER_ID,
		               C.COMMUNITY_COUNT,
		               C.COMMUNITY_ED
		        FROM COMMUNITY C
		        JOIN MEMBER M ON (C.COMMUNITY_WRITER_NO = M.MEMBER_NO)
		        WHERE C.COMMUNITY_STATUS = 'Y' 
		        AND M.MEMBER_ID != 'admin'
		        ORDER BY C.COMMUNITY_ED ASC
		    )
		) ORDER BY RNUM DESC
	</select>
	
	<!-- 1페이지 페이징 처리 관련 쿼리 -->
	<select id="selectBoardListFirstPage" resultMap="communityListResultMap">
		WITH BOARD AS 
		(  
		    SELECT ROWNUM AS RNUM, COMMUNITY_NO, COMMUNITY_CATEGORY, COMMUNITY_TITLE, MEMBER_ID, COMMUNITY_COUNT, COMMUNITY_ED, NOTICE_IMPORTANT_YN
		    FROM (
		        SELECT C.COMMUNITY_NO,
		               C.COMMUNITY_CATEGORY,
		               C.COMMUNITY_TITLE,
		               M.MEMBER_ID,
		               C.COMMUNITY_COUNT,
		               C.COMMUNITY_ED,
		               C.NOTICE_IMPORTANT_YN
		        FROM COMMUNITY C
		        JOIN MEMBER M ON (C.COMMUNITY_WRITER_NO = M.MEMBER_NO)
		        WHERE C.COMMUNITY_STATUS = 'Y'
		        AND C.COMMUNITY_CATEGORY IN ('[수다]', '[마이펫 자랑]')
		        
		        UNION
		        
		        SELECT C.COMMUNITY_NO,
		               C.COMMUNITY_CATEGORY,
		               C.COMMUNITY_TITLE,
		               M.MEMBER_ID,
		               C.COMMUNITY_COUNT,
		               C.COMMUNITY_ED,
		               C.NOTICE_IMPORTANT_YN
		        FROM COMMUNITY C
		        JOIN MEMBER M ON (C.COMMUNITY_WRITER_NO = M.MEMBER_NO)
		        WHERE C.COMMUNITY_STATUS = 'Y'
		        AND C.NOTICE_IMPORTANT_YN = 'Y'
		        ORDER BY NOTICE_IMPORTANT_YN ASC, COMMUNITY_ED ASC
		    )
		    
		)
		SELECT RNUM,
		       COMMUNITY_NO,
		       COMMUNITY_CATEGORY,
		       COMMUNITY_TITLE,
		       MEMBER_ID,
		       COMMUNITY_COUNT,
		       COMMUNITY_ED,
		       NOTICE_IMPORTANT_YN
		FROM BOARD
		ORDER BY RNUM DESC
	</select>
	
	<!-- 추가 -->
	<insert id="insertBoard" parameterType="Community" useGeneratedKeys="true" keyProperty="communityNo" keyColumn="COMMUNITY_NO">
		INSERT INTO COMMUNITY(
			COMMUNITY_NO,
			COMMUNITY_CATEGORY,
			COMMUNITY_TITLE,
			COMMUNITY_CONTENT,
			COMMUNITY_O_FILENAME,
			COMMUNITY_R_FILENAME,
			COMMUNITY_WRITER_NO
		) VALUES(
			SEQ_COMM_NO.NEXTVAL,
			#{communityCategory},
			#{communityTitle},
			#{communityContent},
			#{communityOfileName},
			#{communityRfileName},
			#{communityWriterNo}
		)
	</insert>
	
</mapper>






















